name: Flutter CI Android

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’å®šç¾©
on:
  workflow_dispatch:
#on:
#  push:
#    branches:
#      - main  # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushæ™‚ã«å®Ÿè¡Œ
#  pull_request:
#    branches:
#      - main  # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®PRä½œæˆæ™‚ã«å®Ÿè¡Œ

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å†…ã®ã‚¸ãƒ§ãƒ–ã‚’å®šç¾©
jobs:
  set-env:
    runs-on: ubuntu-latest
    outputs:
      FLUTTER_VERSION: ${{ steps.set_vars.outputs.FLUTTER_VERSION }}
    steps:
      - name: Set vars
        id: set_vars
        run: |
          readonly FLUTTER_VERSION="3.10.1"
          echo "FLUTTER_VERSION=$FLUTTER_VERSION" >> $GITHUB_OUTPUT

  build:
    # ã‚¸ãƒ§ãƒ–ãŒå®Ÿè¡Œã•ã‚Œã‚‹ä»®æƒ³ç’°å¢ƒã‚’æŒ‡å®š
    runs-on: ubuntu-latest
    environment:
      name: KEY_STORE_PASSWORD

    steps:
    # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
    - name: Checkout code
      uses: actions/checkout@v2
    
    # fvmã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
    #- name: "Read flutter version from fvm config"
    #  id: flutter_info
    #  run: |
    #    FLUTTER_VERSION=$(jq -r '.flutterSdkVersion' ./.fvm/fvm_config.json)
    #    echo "FLUTTER_VERSION=$FLUTTER_VERSION" >> $GITHUB_ENV
    #  shell: bash

    # Flutterã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - name: "Setup Flutter"
      uses: subosito/flutter-action@v2
      with:
        #flutter-version: ${{ env.FLUTTER_VERSION }}  # å–å¾—ã—ãŸFlutterãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨
        #flutter-version: ${{ needs.set-env.outputs.FLUTTER_VERSION }}  # å–å¾—ã—ãŸFlutterãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨
        flutter-version: "3.10.1"
        cache: true

    # flutter cleanã‚’å®Ÿè¡Œã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤
    - name: Clean Flutter build
      run: flutter clean

    # Flutterã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: Install dependencies
      run: flutter pub get

    # ãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã§GitHub Secretsã‹ã‚‰.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‹•çš„ã«ä½œæˆ
    #- name: Create .env
    #  run: echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env

    # ãƒªãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
    - name: Run linter
      run: flutter analyze

    # ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
    - name: Run tests
      run: flutter test

    # Androidã®keystoreãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆkey.jksï¼‰ã‚’Secretsã‹ã‚‰ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦é…ç½®
    - name: Decode keystore
      run: echo "${{ secrets.SIGNING_KEY }}" | base64 -d > android/app/key.jks

    # Androidã®ãƒ“ãƒ«ãƒ‰ï¼ˆSecretsã‹ã‚‰ç½²åæƒ…å ±ã‚’å–å¾—ï¼‰
    - name: Build APK (Android)
      run: flutter build apk --release
      env:
        KEY_STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        ALIAS: ${{ secrets.ALIAS }}
        KEY_PATH: key.jks

    # ãƒ“ãƒ«ãƒ‰ã—ãŸapkã‚’github Actionsã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    - name: "Deploy apk ğŸš€"
      uses: actions/upload-artifact@v4
      with:
        name: release-apk  # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®åå‰
        path: build/app/outputs/flutter-apk/app-release.apk
        retention-days: 7 # 7æ—¥é–“ä¿å­˜
